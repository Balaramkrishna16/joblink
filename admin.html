<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - JobSearch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(110deg, #1d4ed8 0%, #4338ca 70%, #6d28d9 100%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255,255,255,0.30);
      border: 2px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(18px) saturate(180%);
      -webkit-backdrop-filter: blur(18px) saturate(180%);
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.22);
    }
    input, textarea {
      border: 2px solid #a5b4fc;
      transition: border 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 2px #c7d2fe;
    }
    button {
      transition: box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(67,56,202,0.12);
    }
    button:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 6px 16px rgba(99,102,241,0.18);
    }
    ::selection {
      background: #a5b4fc;
      color: #312e81;
    }
  </style>
</head>
<body>

  <div id="login-screen" class="w-full max-w-md glass rounded-3xl p-10 text-white shadow-2xl border border-blue-300/50 mx-auto mt-20">
    <h2 class="text-4xl font-extrabold text-center mb-8 tracking-tighter">Job<span class="text-blue-200">Search</span> Admin</h2>
    <form id="login-form" class="space-y-6">
      <input type="email" id="email" placeholder="Email" class="w-full px-5 py-4 rounded-xl text-gray-800 bg-white/80 focus:bg-white/95 focus:ring-2 focus:ring-blue-400 border transition" required />
      <input type="password" id="password" placeholder="Password" class="w-full px-5 py-4 rounded-xl text-gray-800 bg-white/80 focus:bg-white/95 focus:ring-2 focus:ring-blue-400 border transition" required />
      <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-blue-700 via-indigo-600 to-purple-800 text-white text-xl font-semibold hover:opacity-95 transition">Login</button>
    </form>
    <p id="login-error" class="text-red-300 text-sm mt-4 text-center hidden"></p>
  </div>

  <div id="dashboard" class="hidden w-full min-h-screen flex flex-col">

    <header class="flex items-center justify-between px-10 py-5 bg-white shadow-lg border-b border-gray-200">
      <h1 class="text-3xl font-extrabold text-indigo-800">Job<span class="text-blue-600">Search</span> Admin</h1>
      <div class="flex items-center space-x-6">
        <span class="text-gray-700 font-medium">Welcome, Admin</span>
        <button onclick="logout()" class="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">
          Logout
        </button>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <aside class="w-72 bg-white shadow-inner border-r border-gray-200 p-8 flex flex-col space-y-4">
        <!-- All Resources Button -->
        <button onclick="showSection('resources')" class="flex items-center gap-4 px-5 py-4 rounded-xl text-indigo-700 font-semibold text-lg hover:bg-indigo-100 transition focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13a2.003 2.003 0 100 3.999 2.003 2.003 0 000-3.999zm0 0h.01a2.003 2.003 0 110 3.999 2.003 2.003 0 010-3.999zM21 9h-4.25a.75.75 0 00-.75.75v1.5a.75.75 0 00.75.75H21a.75.75 0 00.75-.75v-1.5a.75.75 0 00-.75-.75zM3 9h4.25a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H3A.75.75 0 012.25 11.25v-1.5A.75.75 0 013 9z" /></svg>
          All Resources
        </button>
        <!-- Add Resource Button -->
        <button onclick="showSection('add-resource')" class="flex items-center gap-4 px-5 py-4 rounded-xl text-indigo-700 font-semibold text-lg hover:bg-indigo-100 transition focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
          Add New Resource
        </button>
        <!-- Existing: All Jobs Button -->
        <button onclick="showSection('jobs')" class="flex items-center gap-4 px-5 py-4 rounded-xl text-indigo-700 font-semibold text-lg hover:bg-indigo-100 transition focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a2 2 0 012-2h2a2 2 0 012 2v2m-6 4h6a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
          All Jobs
        </button>
        <!-- Existing: Add Job Button -->
        <button onclick="showSection('add-job')" class="flex items-center gap-4 px-5 py-4 rounded-xl text-indigo-700 font-semibold text-lg hover:bg-indigo-100 transition focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
          Add New Job
        </button>
      </aside>

      <main class="flex-1 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-10 overflow-auto rounded-tr-3xl">

        <!-- New: All Resources Section -->
        <section id="resources-section" class="hidden">
          <h2 class="text-4xl font-extrabold text-indigo-800 mb-10 tracking-wide">All Resources</h2>
          <div id="resources-list" class="grid gap-10 sm:grid-cols-2 lg:grid-cols-3">
             <!-- Resources will be loaded here -->
          </div>
        </section>

        <!-- New: Add Resource Section -->
        <section id="add-resource-section" class="hidden max-w-xl">
          <h2 class="text-4xl font-extrabold text-indigo-800 mb-10 tracking-wide">Add New Resource</h2>
          <form id="add-resource-form" class="space-y-8 p-8 bg-white rounded-3xl shadow-xl border border-indigo-200">
            <input type="text" id="resource-name" placeholder="Resource Name (e.g., Ultimate JS Cheatsheet)" class="w-full px-5 py-4 rounded-xl border border-indigo-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none" required />
            <input type="url" id="resource-link" placeholder="Direct Drive/File Link (Must be a URL)" class="w-full px-5 py-4 rounded-xl border border-indigo-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none" required />
            <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-600 via-purple-700 to-indigo-700 text-white font-bold text-lg hover:opacity-95 transition shadow-lg">Add Resource</button>
          </form>
        </section>

        <!-- Existing: All Jobs Section -->
        <section id="jobs-section" class="hidden">
          <h2 class="text-4xl font-extrabold text-indigo-800 mb-10 tracking-wide">All Job Listings</h2>
          <div id="jobs-list" class="grid gap-10 sm:grid-cols-2 lg:grid-cols-3"></div>
        </section>

        <!-- Existing: Add Job Section -->
        <section id="add-job-section" class="hidden max-w-xl">
          <h2 class="text-4xl font-extrabold text-indigo-800 mb-10 tracking-wide">Add New Job</h2>
          <form id="add-job-form" class="space-y-8 p-8 bg-white rounded-3xl shadow-xl border border-indigo-200">
            <input type="text" id="job-title" placeholder="Job Title" class="w-full px-5 py-4 rounded-xl border border-indigo-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none" required />
            <input type="text" id="job-company" placeholder="Company Name" class="w-full px-5 py-4 rounded-xl border border-indigo-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none" required />
            <textarea id="job-description" placeholder="Job Description" rows="6" class="w-full px-5 py-4 rounded-xl border border-indigo-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none" required></textarea>
            <input type="text" id="job-location" placeholder="Location" class="w-full px-5 py-4 rounded-xl border border-indigo-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none" required />
            <input type="text" id="job-link" placeholder="Apply Link" class="w-full px-5 py-4 rounded-xl border border-indigo-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none" required />
            <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-600 via-purple-700 to-indigo-700 text-white font-bold text-lg hover:opacity-95 transition shadow-lg">Add Job</button>
          </form>
        </section>
      </main>
    </div>
  </div>

  <!-- CRITICAL FIX: Ensure env-config.js is loaded BEFORE the main script -->
  <script src="env-config.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, Timestamp, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // CLEAN CONFIG: Directly use the window.env object (no hardcoded fallback)
    const firebaseConfig = {
      apiKey: window.env?.APP_FIREBASE_API_KEY,
      authDomain: window.env?.APP_FIREBASE_AUTH_DOMAIN,
      projectId: window.env?.APP_FIREBASE_PROJECT_ID,
      storageBucket: window.env?.APP_FIREBASE_STORAGE_BUCKET,
      messagingSenderId: window.env?.APP_FIREBASE_MESSAGING_SENDER_ID,
      appId: window.env?.APP_FIREBASE_APP_ID,
      measurementId: window.env?.APP_FIREBASE_MEASUREMENT_ID
    };
    
    // BASIC CHECK: Ensure Firebase initialized
    if (!firebaseConfig.apiKey) {
        console.error("FIREBASE ERROR: API Key is missing. Check if 'env-config.js' loaded correctly.");
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const jobsList = document.getElementById('jobs-list');
    const resourcesList = document.getElementById('resources-list'); 
    const addResourceForm = document.getElementById('add-resource-form');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      loginError.classList.add("hidden"); // Hide previous error
      
      try {
        // Attempt to sign in
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log("Login successful:", userCredential.user.uid);
        // The onAuthStateChanged listener handles the screen switch
        
      } catch (error) {
        console.error("Login attempt failed:", error.code, error.message);
        loginError.textContent = "Invalid credentials or login failed. Try again.";
        loginError.classList.remove("hidden");
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is logged in
        loginScreen.classList.add('hidden');
        dashboard.classList.remove('hidden');
        showSection('resources'); // Default to resources on login
        loadResources();
        loadJobs();
      } else {
        // User is logged out
        loginScreen.classList.remove('hidden');
        dashboard.classList.add('hidden');
      }
    });
    
    // --- Job Management ---
    document.getElementById('add-job-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const job = {
        title: document.getElementById('job-title').value,
        company: document.getElementById('job-company').value,
        description: document.getElementById('job-description').value,
        location: document.getElementById('job-location').value,
        applyLink: document.getElementById('job-link').value,
        postedAt: Timestamp.now() 
      };
      await addDoc(collection(db, "jobs"), job);
      alert("Job added successfully!");
      e.target.reset();
      showSection('jobs');
      loadJobs();
    });

    async function loadJobs() {
      jobsList.innerHTML = '';
      
      const jobsCollectionRef = collection(db, "jobs");
      const querySnapshot = await getDocs(jobsCollectionRef);
      
      const now = new Date().getTime();
      const twentyDaysInMs = 20 * 24 * 60 * 60 * 1000;
      let jobsDeleted = false;

      // Filter and Delete Expired Jobs
      const activeJobs = [];
      const jobsToDelete = [];

      querySnapshot.forEach((docSnap) => {
          const job = docSnap.data();
          // Safely check if postedAt exists and is a Firestore Timestamp
          const postedTime = job.postedAt && job.postedAt.toDate ? job.postedAt.toDate().getTime() : 0;
          
          if (postedTime !== 0 && now - postedTime > twentyDaysInMs) {
              jobsToDelete.push(docSnap.id);
              jobsDeleted = true;
          } else {
              activeJobs.push({ id: docSnap.id, ...job });
          }
      });
      
      // Perform Deletion of Expired Jobs
      for (const id of jobsToDelete) {
          await deleteDoc(doc(db, "jobs", id));
      }

      if (jobsDeleted) {
          console.log(`Deleted ${jobsToDelete.length} expired jobs. Reloading list.`);
          return loadJobs(); 
      }

      // Display Active Jobs
      if (activeJobs.length === 0) {
        jobsList.innerHTML = `<p class="text-center text-gray-500 col-span-full py-16">No jobs available to manage.</p>`;
        return;
      }
      
      activeJobs.forEach((job) => {
        const postedDate = job.postedAt ? job.postedAt.toDate().toLocaleDateString() : 'N/A';

        jobsList.innerHTML += `
          <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col border border-indigo-200 hover:shadow-2xl transition">
            <h3 class="text-2xl font-bold text-indigo-800 mb-2">${job.title}</h3>
            <p class="text-base text-gray-600 mb-2">${job.company}</p>
            <p class="text-sm text-gray-500 mb-2">Posted: ${postedDate}</p>
            <p class="text-gray-700 flex-grow mb-4">${job.description.slice(0, 100)}...</p>
            <p class="text-sm text-indigo-600 mb-4 font-semibold">${job.location}</p>
            <div class="flex justify-between items-center gap-4">
              <a href="${job.applyLink}" target="_blank" class="bg-indigo-100 text-indigo-700 px-5 py-2 rounded-lg hover:bg-indigo-200 font-semibold transition">View</a>
              <button onclick="deleteJob('${job.id}')" class="bg-red-100 text-red-700 px-5 py-2 rounded-lg hover:bg-red-200 font-semibold transition">Delete</button>
            </div>
          </div>
        `;
      });
    }

    window.deleteJob = async (id) => {
      if (confirm("Are you sure you want to delete this job?")) {
        await deleteDoc(doc(db, "jobs", id));
        loadJobs();
      }
    };

    // --- Resource Management ---

    addResourceForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const resource = {
        name: document.getElementById('resource-name').value,
        link: document.getElementById('resource-link').value,
        createdAt: new Date().toISOString()
      };
      await addDoc(collection(db, "resources"), resource);
      alert("Resource added successfully!");
      e.target.reset();
      showSection('resources');
      loadResources();
    });

    async function loadResources() {
      resourcesList.innerHTML = '';
      const querySnapshot = await getDocs(collection(db, "resources"));
      if (querySnapshot.empty) {
        resourcesList.innerHTML = `<p class="text-center text-gray-500 col-span-full py-16">No resources available to manage.</p>`;
        return;
      }
      querySnapshot.forEach((docSnap) => {
        const resource = docSnap.data();
        resourcesList.innerHTML += `
          <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col border border-purple-200 hover:shadow-2xl transition">
            <h3 class="text-2xl font-bold text-purple-800 mb-2">${resource.name}</h3>
            <p class="text-sm text-gray-500 mb-4">Link: <a href="${resource.link}" target="_blank" class="text-blue-500 hover:underline">View</a></p>
            <div class="flex justify-between items-center gap-4 mt-auto">
              <a href="${resource.link}" target="_blank" class="bg-purple-100 text-purple-700 px-5 py-2 rounded-lg hover:bg-purple-200 font-semibold transition">Open Link</a>
              <button onclick="deleteResource('${docSnap.id}')" class="bg-red-100 text-red-700 px-5 py-2 rounded-lg hover:bg-red-200 font-semibold transition">Delete</button>
            </div>
          </div>
        `;
      });
    }

    window.deleteResource = async (id) => {
      if (confirm("Are you sure you want to delete this resource?")) {
        await deleteDoc(doc(db, "resources", id));
        loadResources();
      }
    };

    // --- Utility Functions ---
    window.showSection = (section) => {
      document.getElementById('jobs-section').classList.add('hidden');
      document.getElementById('add-job-section').classList.add('hidden');
      document.getElementById('resources-section').classList.add('hidden');
      document.getElementById('add-resource-section').classList.add('hidden');
      
      document.getElementById(`${section}-section`).classList.remove('hidden');

      if (section === 'jobs') loadJobs();
      if (section === 'resources') loadResources();
    };

    window.logout = () => {
      signOut(auth);
    };
  </script>
</body>
</html>
